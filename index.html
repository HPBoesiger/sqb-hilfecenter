<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQB Hilfecenter</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --sqb-primary: #1a365d;
      --sqb-primary-light: #2c5282;
      --sqb-accent: #ed8936;
      --sqb-accent-light: #f6ad55;
      --sqb-bg: #f7fafc;
      --sqb-card: #ffffff;
      --sqb-text: #1a202c;
      --sqb-text-muted: #718096;
      --sqb-border: #e2e8f0;
      --sqb-success: #38a169;
      --sqb-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --sqb-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--sqb-bg);
      color: var(--sqb-text);
      line-height: 1.6;
    }

    .hilfecenter {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--sqb-primary) 0%, var(--sqb-primary-light) 100%);
      color: white;
      padding: 2rem 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 60%;
      height: 200%;
      background: radial-gradient(ellipse, rgba(237, 137, 54, 0.15) 0%, transparent 70%);
      pointer-events: none;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .header-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }

    .header-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Search Bar */
    .search-container {
      max-width: 1200px;
      margin: -1.5rem auto 0;
      padding: 0 1.5rem;
      position: relative;
      z-index: 10;
    }

    .search-bar {
      background: var(--sqb-card);
      border-radius: 12px;
      box-shadow: var(--sqb-shadow-lg);
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      gap: 0.75rem;
      border: 2px solid transparent;
      transition: border-color 0.2s ease;
    }

    .search-bar:focus-within {
      border-color: var(--sqb-accent);
    }

    .search-bar svg {
      color: var(--sqb-text-muted);
      flex-shrink: 0;
    }

    .search-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 1rem;
      font-family: inherit;
      color: var(--sqb-text);
      background: transparent;
    }

    .search-input::placeholder {
      color: var(--sqb-text-muted);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      width: 100%;
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--sqb-border);
      background: var(--sqb-card);
      color: var(--sqb-text);
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      border-color: var(--sqb-primary);
      color: var(--sqb-primary);
    }

    .filter-btn.active {
      background: var(--sqb-primary);
      border-color: var(--sqb-primary);
      color: white;
    }

    /* Articles Grid */
    .articles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.25rem;
    }

    .article-card {
      background: var(--sqb-card);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--sqb-shadow);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--sqb-border);
      display: flex;
      flex-direction: column;
    }

    .article-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--sqb-shadow-lg);
      border-color: var(--sqb-accent);
    }

    .article-header {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .article-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--sqb-primary) 0%, var(--sqb-primary-light) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }

    .article-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--sqb-text);
      line-height: 1.4;
    }

    .article-description {
      color: var(--sqb-text-muted);
      font-size: 0.9rem;
      margin-bottom: 1rem;
      flex: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .article-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .article-tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      background: var(--sqb-bg);
      border-radius: 4px;
      color: var(--sqb-text-muted);
      font-weight: 500;
    }

    .article-tag.product {
      background: rgba(237, 137, 54, 0.1);
      color: var(--sqb-accent);
    }

    /* Article Detail View */
    .article-detail {
      background: var(--sqb-card);
      border-radius: 12px;
      box-shadow: var(--sqb-shadow);
      overflow: hidden;
    }

    .detail-header {
      background: linear-gradient(135deg, var(--sqb-primary) 0%, var(--sqb-primary-light) 100%);
      color: white;
      padding: 1.5rem;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: inherit;
      cursor: pointer;
      margin-bottom: 1rem;
      transition: background 0.2s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .detail-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .detail-meta {
      display: flex;
      gap: 1rem;
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .detail-content {
      padding: 1.5rem;
    }

    .detail-description {
      font-size: 1rem;
      color: var(--sqb-text-muted);
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--sqb-border);
    }

    .steps-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--sqb-text);
    }

    .step {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--sqb-border);
    }

    .step:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .step-number {
      width: 32px;
      height: 32px;
      background: var(--sqb-accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
    }

    .step-text {
      font-size: 0.95rem;
      color: var(--sqb-text);
      line-height: 1.6;
    }

    .step-assets {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .asset-link {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      background: var(--sqb-bg);
      border-radius: 6px;
      color: var(--sqb-primary);
      font-size: 0.8rem;
      text-decoration: none;
      transition: background 0.2s ease;
    }

    .asset-link:hover {
      background: var(--sqb-border);
    }

    /* Chat Widget */
    .chat-toggle {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--sqb-accent) 0%, var(--sqb-accent-light) 100%);
      border-radius: 50%;
      border: none;
      color: white;
      cursor: pointer;
      box-shadow: var(--sqb-shadow-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      z-index: 1000;
    }

    .chat-toggle:hover {
      transform: scale(1.05);
    }

    .chat-panel {
      position: fixed;
      bottom: 5.5rem;
      right: 1.5rem;
      width: 380px;
      max-height: 500px;
      background: var(--sqb-card);
      border-radius: 16px;
      box-shadow: var(--sqb-shadow-lg);
      display: none;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
    }

    .chat-panel.open {
      display: flex;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-header {
      background: linear-gradient(135deg, var(--sqb-primary) 0%, var(--sqb-primary-light) 100%);
      color: white;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-header-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .chat-close {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .chat-close:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 250px;
      max-height: 350px;
    }

    .chat-message {
      max-width: 85%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .chat-message.user {
      background: var(--sqb-primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      background: var(--sqb-bg);
      color: var(--sqb-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .chat-message.typing {
      display: flex;
      gap: 4px;
      padding: 1rem;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--sqb-text-muted);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    .chat-input-container {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--sqb-border);
      display: flex;
      gap: 0.5rem;
    }

    .chat-input {
      flex: 1;
      padding: 0.625rem 0.875rem;
      border: 1px solid var(--sqb-border);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .chat-input:focus {
      border-color: var(--sqb-accent);
    }

    .chat-send {
      width: 40px;
      height: 40px;
      background: var(--sqb-accent);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    .chat-send:hover {
      background: var(--sqb-accent-light);
    }

    .chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--sqb-text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--sqb-text-muted);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--sqb-border);
      border-top-color: var(--sqb-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.75rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error State */
    .error-state {
      text-align: center;
      padding: 2rem;
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 12px;
      color: #c53030;
    }

    .error-state button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      background: #c53030;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .header {
        padding: 1.5rem 1rem;
      }
      
      .header-title {
        font-size: 1.5rem;
      }

      .search-container {
        padding: 0 1rem;
      }

      .main-content {
        padding: 1.5rem 1rem;
      }

      .articles-grid {
        grid-template-columns: 1fr;
      }

      .chat-panel {
        width: calc(100% - 2rem);
        right: 1rem;
        left: 1rem;
      }
    }

    /* Hide detail view by default */
    #detail-view {
      display: none;
    }

    #detail-view.active {
      display: block;
    }

    #list-view.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="hilfecenter">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1 class="header-title">SQB Hilfecenter</h1>
        <p class="header-subtitle">Anleitungen, Tipps und Unterst√ºtzung f√ºr alle SQB-Produkte</p>
      </div>
    </header>

    <!-- Suchleiste -->
    <div class="search-container">
      <div class="search-bar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" class="search-input" id="search-input" placeholder="Suchen Sie nach Anleitungen, Produkten oder Stichworten...">
      </div>
    </div>

    <!-- Hauptinhalt -->
    <main class="main-content">
      <!-- Listenansicht -->
      <div id="list-view">
        <!-- Filter -->
        <div class="filters" id="filters">
          <button class="filter-btn active" data-filter="Alle">Alle</button>
        </div>

        <!-- Artikel -->
        <div id="articles-container">
          <div class="loading" id="loading">
            <div class="spinner"></div>
            Laden...
          </div>
        </div>
      </div>

      <!-- Detailansicht -->
      <div id="detail-view" class="article-detail">
        <div class="detail-header">
          <button class="back-btn" id="back-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
            Zur√ºck zur √úbersicht
          </button>
          <h2 class="detail-title" id="detail-title"></h2>
          <div class="detail-meta" id="detail-meta"></div>
        </div>
        <div class="detail-content">
          <p class="detail-description" id="detail-description"></p>
          <div id="detail-steps"></div>
        </div>
      </div>
    </main>

    <!-- Chat Toggle -->
    <button class="chat-toggle" id="chat-toggle">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
    </button>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chat-panel">
      <div class="chat-header">
        <span class="chat-header-title">üí¨ SQB Assistent</span>
        <button class="chat-close" id="chat-close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
          </svg>
        </button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-message assistant">
          Willkommen im SQB Hilfecenter! Wie kann ich Ihnen helfen?
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chat-input" placeholder="Ihre Frage eingeben...">
        <button class="chat-send" id="chat-send">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // KONFIGURATION
    // ============================================
    const CONFIG = {
      firebase: {
        apiKey: "AIzaSyBHUu8ozRsAyy_1vMQz-WpANTnQgcXMc5B",
        projectId: "risikoanalyse-2025"
      },
      openai: {
        apiKey: "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"
      },
      sharepoint: {
        baseUrl: "https://sqbag.sharepoint.com/sites/Demoportal/Hilfecenter/01_Produkte/"
      }
    };

    // ============================================
    // GLOBALE VARIABLEN
    // ============================================
    let articles = [];
    let selectedProduct = 'Alle';
    let chatMessages = [];

    // ============================================
    // DOM ELEMENTE
    // ============================================
    const searchInput = document.getElementById('search-input');
    const filtersContainer = document.getElementById('filters');
    const articlesContainer = document.getElementById('articles-container');
    const loadingEl = document.getElementById('loading');
    const listView = document.getElementById('list-view');
    const detailView = document.getElementById('detail-view');
    const backBtn = document.getElementById('back-btn');
    const chatToggle = document.getElementById('chat-toggle');
    const chatPanel = document.getElementById('chat-panel');
    const chatClose = document.getElementById('chat-close');
    const chatMessagesEl = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    // ============================================
    // FIREBASE API
    // ============================================
    const firestoreUrl = `https://firestore.googleapis.com/v1/projects/${CONFIG.firebase.projectId}/databases/(default)/documents`;

    async function fetchHilfeArticles() {
      try {
        const response = await fetch(`${firestoreUrl}/hilfecenter?key=${CONFIG.firebase.apiKey}`);
        const data = await response.json();
        
        if (!data.documents) return [];
        
        return data.documents.map(doc => {
          const fields = doc.fields;
          const id = doc.name.split('/').pop();
          
          return {
            id,
            titel: fields.titel?.stringValue || '',
            beschreibung: fields.beschreibung?.stringValue || '',
            produkte: fields.produkte?.arrayValue?.values?.map(v => v.stringValue) || [],
            typ: fields.typ?.stringValue || '',
            zielgruppe: fields.zielgruppe?.stringValue || '',
            schritte: fields.schritte?.arrayValue?.values?.map(s => ({
              nr: s.mapValue?.fields?.nr?.integerValue || s.mapValue?.fields?.nr?.stringValue || 0,
              text: s.mapValue?.fields?.text?.stringValue || '',
              assets: s.mapValue?.fields?.assets?.arrayValue?.values?.map(a => a.stringValue) || []
            })) || [],
            stichworte: fields.stichworte?.arrayValue?.values?.map(v => v.stringValue) || [],
            assetPfad: fields.assetPfad?.stringValue || ''
          };
        });
      } catch (error) {
        console.error('Fehler beim Laden der Artikel:', error);
        throw error;
      }
    }

    // ============================================
    // OPENAI API
    // ============================================
    async function chatWithAssistant(messages) {
      const systemPrompt = `Du bist der SQB Hilfecenter-Assistent. Du hilfst Benutzern bei Fragen zu den SQB-Produkten und -Tools.

Verf√ºgbare Hilfeartikel:
${articles.map(a => `- "${a.titel}" (${a.produkte.join(', ')}): ${a.beschreibung}`).join('\n')}

Beantworte Fragen freundlich und pr√§zise auf Deutsch. Wenn ein Hilfeartikel relevant ist, verweise darauf mit dem genauen Titel.
Wenn du keine passende Antwort findest, sage dem Benutzer, dass er die Suchfunktion nutzen oder den Support kontaktieren kann.`;

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.openai.apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: systemPrompt },
              ...messages
            ],
            max_tokens: 500,
            temperature: 0.7
          })
        });

        const data = await response.json();
        return data.choices?.[0]?.message?.content || 'Entschuldigung, ich konnte keine Antwort generieren.';
      } catch (error) {
        console.error('Chat-Fehler:', error);
        return 'Entschuldigung, es ist ein Fehler aufgetreten. Bitte versuchen Sie es sp√§ter erneut.';
      }
    }

    // ============================================
    // RENDER FUNKTIONEN
    // ============================================
    function renderFilters() {
      const products = ['Alle', ...new Set(articles.flatMap(a => a.produkte))];
      
      filtersContainer.innerHTML = products.map(product => `
        <button class="filter-btn ${selectedProduct === product ? 'active' : ''}" data-filter="${product}">
          ${product}
        </button>
      `).join('');

      // Event Listener
      filtersContainer.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedProduct = btn.dataset.filter;
          renderFilters();
          renderArticles();
        });
      });
    }

    function renderArticles() {
      const searchQuery = searchInput.value.toLowerCase();
      
      const filtered = articles.filter(article => {
        const matchesSearch = searchQuery === '' || 
          article.titel.toLowerCase().includes(searchQuery) ||
          article.beschreibung.toLowerCase().includes(searchQuery) ||
          article.stichworte.some(s => s.toLowerCase().includes(searchQuery));
        
        const matchesProduct = selectedProduct === 'Alle' || 
          article.produkte.includes(selectedProduct);
        
        return matchesSearch && matchesProduct;
      });

      if (filtered.length === 0) {
        articlesContainer.innerHTML = `
          <div class="empty-state">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            <p>Keine Artikel gefunden</p>
            <p style="font-size: 0.875rem">Versuchen Sie andere Suchbegriffe oder nutzen Sie den Chat-Assistenten</p>
          </div>
        `;
        return;
      }

      articlesContainer.innerHTML = `
        <div class="articles-grid">
          ${filtered.map(article => `
            <div class="article-card" data-id="${article.id}">
              <div class="article-header">
                <div class="article-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                  </svg>
                </div>
                <h3 class="article-title">${article.titel}</h3>
              </div>
              <p class="article-description">${article.beschreibung}</p>
              <div class="article-meta">
                ${article.produkte.slice(0, 2).map(p => `<span class="article-tag product">${p}</span>`).join('')}
                ${article.typ ? `<span class="article-tag">${article.typ}</span>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Event Listener f√ºr Karten
      articlesContainer.querySelectorAll('.article-card').forEach(card => {
        card.addEventListener('click', () => {
          const article = articles.find(a => a.id === card.dataset.id);
          if (article) showDetail(article);
        });
      });
    }

    function showDetail(article) {
      document.getElementById('detail-title').textContent = article.titel;
      document.getElementById('detail-description').textContent = article.beschreibung;
      
      // Meta
      const metaParts = [article.produkte.join(', ')];
      if (article.typ) metaParts.push(article.typ);
      if (article.zielgruppe) metaParts.push(article.zielgruppe);
      document.getElementById('detail-meta').innerHTML = metaParts.map(p => `<span>${p}</span>`).join(' ‚Ä¢ ');

      // Schritte
      const stepsContainer = document.getElementById('detail-steps');
      if (article.schritte.length > 0) {
        const sortedSteps = [...article.schritte].sort((a, b) => Number(a.nr) - Number(b.nr));
        
        stepsContainer.innerHTML = `
          <h3 class="steps-title">Schritt-f√ºr-Schritt Anleitung</h3>
          ${sortedSteps.map((schritt, idx) => `
            <div class="step">
              <div class="step-number">${schritt.nr || idx + 1}</div>
              <div class="step-content">
                <p class="step-text">${schritt.text}</p>
                ${schritt.assets.length > 0 ? `
                  <div class="step-assets">
                    ${schritt.assets.map(asset => `
                      <a href="${CONFIG.sharepoint.baseUrl}${article.assetPfad}${asset}" 
                         target="_blank" 
                         rel="noopener noreferrer" 
                         class="asset-link">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                          <circle cx="9" cy="9" r="2"/>
                          <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                        </svg>
                        ${asset}
                      </a>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          `).join('')}
        `;
      } else {
        stepsContainer.innerHTML = '';
      }

      // Views umschalten
      listView.classList.add('hidden');
      detailView.classList.add('active');
    }

    function hideDetail() {
      listView.classList.remove('hidden');
      detailView.classList.remove('active');
    }

    // ============================================
    // CHAT FUNKTIONEN
    // ============================================
    function addChatMessage(role, content) {
      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${role}`;
      messageEl.textContent = content;
      chatMessagesEl.appendChild(messageEl);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function showTyping() {
      const typingEl = document.createElement('div');
      typingEl.className = 'chat-message assistant typing';
      typingEl.id = 'typing-indicator';
      typingEl.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      chatMessagesEl.appendChild(typingEl);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function hideTyping() {
      const typingEl = document.getElementById('typing-indicator');
      if (typingEl) typingEl.remove();
    }

    async function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // User Message anzeigen
      addChatMessage('user', message);
      chatInput.value = '';
      chatSend.disabled = true;

      // API Nachricht hinzuf√ºgen
      chatMessages.push({ role: 'user', content: message });

      // Typing Indicator
      showTyping();

      // API aufrufen
      const response = await chatWithAssistant(chatMessages);

      // Typing entfernen und Antwort anzeigen
      hideTyping();
      addChatMessage('assistant', response);
      chatMessages.push({ role: 'assistant', content: response });

      chatSend.disabled = false;
    }

    // ============================================
    // EVENT LISTENER
    // ============================================
    searchInput.addEventListener('input', renderArticles);
    backBtn.addEventListener('click', hideDetail);
    
    chatToggle.addEventListener('click', () => {
      chatPanel.classList.toggle('open');
    });

    chatClose.addEventListener('click', () => {
      chatPanel.classList.remove('open');
    });

    chatSend.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendChatMessage();
    });

    // ============================================
    // INITIALISIERUNG
    // ============================================
    async function init() {
      try {
        articles = await fetchHilfeArticles();
        loadingEl.style.display = 'none';
        renderFilters();
        renderArticles();
      } catch (error) {
        loadingEl.innerHTML = `
          <div class="error-state">
            <p><strong>Fehler beim Laden der Artikel</strong></p>
            <p>${error.message}</p>
            <button onclick="location.reload()">Erneut versuchen</button>
          </div>
        `;
      }
    }

    // App starten
    init();
  </script>
</body>
</html>
